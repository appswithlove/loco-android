name: Build

on:
    push:
        branches: [ "main" ]
    pull_request:
        branches: [ "main" ]

jobs:
    build:
        runs-on: ubuntu-latest
        steps:
        - uses: actions/checkout@v3
        - name: set up JDK 21
          uses: actions/setup-java@v3
          with:
              java-version: '21'
              distribution: 'temurin'
              cache: gradle

        - name: Grant execute permission for gradlew
          run: chmod +x gradlew
        - name: Build with Gradle
          run: ./gradlew build

        - name: Validate Maven Central publishing setup
          run: ./gradlew :lib:publishToMavenLocal --dry-run

        - name: Validate Gradle Plugin Portal publishing setup
          run: ./gradlew :lib:publishPlugins --validate-only
          env:
            ORG_GRADLE_PROJECT_signingInMemoryKey: ${{ secrets.SIGNING_PRIVATE_KEY }}
            ORG_GRADLE_PROJECT_signingInMemoryKeyPassword: ${{ secrets.SIGNING_PASSWORD }}
